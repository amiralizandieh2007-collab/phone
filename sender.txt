<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sender (Phone) — با PIN</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:720px;margin:18px auto;padding:12px}
    input,button{font-size:1rem;padding:8px;margin:6px 0}
    video{width:100%;max-width:420px;border:1px solid #ccc;border-radius:6px}
    .hidden{display:none}
  </style>
</head>
<body>
  <h2>فرستنده — باز کردن دوربین (با PIN)</h2>
  <p>برای فعال شدن دوربین، ابتدا کد (PIN) را وارد کن.</p>

  <label>کد (PIN): <input id="pinInput" placeholder="مثال: 1234"></label>
  <button id="pinBtn">ارسال کد و فعال‌سازی</button>

  <div id="status"></div>

  <div id="videoArea" class="hidden">
    <p>Peer ID (فرستنده): <strong id="myId">در حال آماده‌سازی...</strong></p>
    <video id="localVideo" autoplay playsinline muted></video>
    <p style="font-size:.9rem;color:#555">نکته: مرورگر از شما اجازه دسترسی به دوربین را می‌پرسد — آن را تأیید کنید.</p>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    // --- تنظیم PIN اینجا ---
    const CORRECT_PIN = "1234"; // این را به هر عدد/رشته‌ای که می‌خواهی تغییر بده
    // ------------------------

    const pinBtn = document.getElementById('pinBtn');
    const pinInput = document.getElementById('pinInput');
    const status = document.getElementById('status');
    const videoArea = document.getElementById('videoArea');
    const myIdSpan = document.getElementById('myId');
    const localVideo = document.getElementById('localVideo');

    let peer = null;
    let localStream = null;

    pinBtn.addEventListener('click', async () => {
      const v = (pinInput.value || "").trim();
      if (!v) return status.textContent = "لطفاً کد را وارد کن.";
      if (v !== CORRECT_PIN) {
        status.textContent = "کد نادرست است.";
        return;
      }
      status.textContent = "کد درست! حالا دوربین را فعال کنید (مرورگر سوال می‌پرسد).";
      // نمایش و گرفتن دسترسی دوربین
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        localVideo.srcObject = localStream;
        videoArea.classList.remove('hidden');

        // ساخت peer (استفاده از سرور پیش‌فرض PeerJS)
        peer = new Peer();
        peer.on('open', id => {
          myIdSpan.textContent = id;
          status.textContent = "آماده است — آیدی را در صفحهٔ لپ‌تاپ وارد کنید.";
        });

        // وقتی گیرنده تماس (call) می‌گیرد، استریم محلی را پاس می‌دهیم
        peer.on('call', call => {
          call.answer(localStream);
        });

      } catch (err) {
        console.error(err);
        status.textContent = "دسترسی به دوربین لازم است یا خطا رخ داده: " + (err.message || err);
      }
    });
  </script>
</body>
</html>